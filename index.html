<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Auto Image Reducer</title>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #060606;
        color: #fff;
        transition: background 0.3s, color 0.3s;
    }

    /* Light mode */
    body.light {
        background: #fafafa;
        color: #111;
    }

    .container {
        max-width: 900px;
        margin: auto;
        padding: 20px;
        text-align: center;
    }

    /* Neon animated border */
    .neon-box {
        border: 2px solid rgba(255, 0, 200, 0.6);
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 0 25px rgba(255, 0, 200, 0.6), inset 0 0 20px rgba(0, 240, 255, 0.3);
        animation: glow 2s infinite alternate;
    }

    @keyframes glow {
        from { box-shadow: 0 0 10px #ff00c8, inset 0 0 5px #00f0ff; }
        to   { box-shadow: 0 0 25px #ff00c8, inset 0 0 20px #00f0ff; }
    }

    /* Drag-and-drop zone (small mobile-friendly) */
    #drop-area {
        width: 180px;
        height: 90px;
        margin: 20px auto;
        border: 2px dashed #ff00c8;
        border-radius: 12px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 13px;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.04);
    }

    #drop-area:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .hidden-input {
        display: none;
    }

    .result-section {
        margin-top: 30px;
        padding: 20px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
    }

    .preview-img {
        max-width: 180px;
        border-radius: 10px;
        margin-top: 10px;
    }

    button {
        margin: 6px;
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        background: #ff00c8;
        color: #fff;
        cursor: pointer;
        font-size: 14px;
        transition: 0.2s;
    }

    button:hover {
        background: #ff44dd;
    }

    .credit {
        margin-top: 40px;
        font-family: "Brush Script MT", cursive;
        font-size: 26px;
        animation: glowText 4s infinite alternate;
    }

    @keyframes glowText {
        from { text-shadow: 0 0 8px #ff00c8; }
        to   { text-shadow: 0 0 18px #00eaff; }
    }

    .toggle {
        position: absolute;
        top: 10px;
        right: 10px;
    }

</style>
</head>

<body>
<div class="toggle">
    <button onclick="toggleMode()">Toggle Light/Dark</button>
</div>

<div class="container">
    <h1>Auto Image Size Reducer</h1>

    <div id="drop-area" onclick="fileInput.click()">
        Tap or Drop Image Here
    </div>
    <input id="file-input" type="file" accept="image/*" class="hidden-input" />

    <button onclick="clearAll()">Clear All</button>

    <div id="results"></div>

    <div class="credit">Created by Animesh</div>
</div>

<script>
const fileInput = document.getElementById("file-input");
const dropArea = document.getElementById("drop-area");
const results = document.getElementById("results");

dropArea.addEventListener("dragover", e => { e.preventDefault(); });
dropArea.addEventListener("drop", e => {
    e.preventDefault();
    processFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener("change", () => {
    processFile(fileInput.files[0]);
});

/* Toggle Light/Dark Mode */
function toggleMode() {
    document.body.classList.toggle("light");
}

/* Clear All */
function clearAll() {
    results.innerHTML = "";
    fileInput.value = "";
}

/* Format size in KB + MB */
function formatSize(bytes) {
    const kb = (bytes / 1024).toFixed(2);
    const mb = (bytes / (1024 * 1024)).toFixed(2);
    return `${kb} KB (${mb} MB)`;
}

/* Compress Utility */
async function compressImage(file, quality = 0.7, scale = 1) {
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement("canvas");
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(
                blob => {
                    resolve({
                        blob,
                        url: URL.createObjectURL(blob),
                        size: blob.size,
                        width: canvas.width,
                        height: canvas.height
                    });
                },
                "image/jpeg",
                quality
            );
        };
        img.src = URL.createObjectURL(file);
    });
}

/* Stage 3 auto-fallback scale reducing */
async function stage3Auto(originalFile) {
    let scales = [0.6, 0.5, 0.4, 0.3];
    for (let s of scales) {
        let out = await compressImage(originalFile, 0.6, s);
        if (out.size < originalFile.size) return out;
    }
    return null;
}

/* MAIN PROCESSOR */
async function processFile(file) {
    if (!file) return;

    results.innerHTML = "<h3>Processing…</h3>";

    const originalSize = file.size;

    // Stage 1: Q70
    let stage1 = await compressImage(file, 0.7, 1);

    // Stage 2: Q30
    let stage2 = await compressImage(file, 0.3, 1);

    // Stage 3: auto scale + Q60
    let stage3 = await stage3Auto(file);

    results.innerHTML = ""; // clear processing message

    addStageOutput(file, "stage1", stage1);
    addStageOutput(file, "stage2", stage2);
    if (stage3) addStageOutput(file, "stage3", stage3);
}

/* Display + ZIP + Email */
function addStageOutput(originalFile, stageName, output) {
    if (output.size >= originalFile.size) return;

    const section = document.createElement("div");
    section.className = "result-section";

    const newName = originalFile.name.replace(/\.[^.]+$/, "") + `_${stageName}.jpg`;

    const blobFile = new File([output.blob], newName, { type: "image/jpeg" });

    section.innerHTML = `
        <h3>${stageName.toUpperCase()}</h3>
        <img class="preview-img" src="${output.url}" />

        <p><b>Resolution:</b> ${output.width} × ${output.height}</p>
        <p><b>Output Size:</b> ${formatSize(output.size)}</p>
        <p><b>Reduction:</b> 
            ${((1 - output.size / originalFile.size) * 100).toFixed(1)}%
        </p>

        <button onclick="downloadFile('${newName}', '${output.url}')">Download</button>
        <button onclick="downloadZipStage('${stageName}')">Download ZIP (Stage Only)</button>
        <button onclick="emailFile('${newName}', '${output.url}')">Email File</button>
    `;

    results.appendChild(section);

    // Save files per-stage
    if (!window.stageFiles) window.stageFiles = {};
    if (!window.stageFiles[stageName]) window.stageFiles[stageName] = [];
    window.stageFiles[stageName].push(blobFile);
}

/* Download single */
function downloadFile(name, url) {
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    a.click();
}

/* Download ZIP for stage */
async function downloadZipStage(stageName) {
    const files = window.stageFiles?.[stageName];
    if (!files || files.length === 0) return alert("No files.");

    const zip = new JSZip();
    files.forEach(f => zip.file(f.name, f));

    const blob = await zip.generateAsync({ type: "blob" });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${stageName}.zip`;
    a.click();
}

/* Email button */
function emailFile(name, url) {
    const mail = `mailto:?subject=Reduced Image&body=Your reduced file (${name}) is here: ${url}`;
    window.location.href = mail;
}

</script>

<!-- JSZip CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

</body>
</html>
